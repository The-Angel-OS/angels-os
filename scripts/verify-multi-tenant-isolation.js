/**
 * Multi-Tenant Isolation Verification Script
 * Generated by Claude Code CLI
 * 
 * Tests:
 * - Tenant provisioning
 * - Data isolation (cross-tenant access prevention)
 * - AI Bus message visibility
 * - Constitutional defaults (visibility=tenant)
 * - User authentication per tenant
 */

import { getPayload } from 'payload'
import config from '../dist/payload.config.js'

let testResults = {
  provisioning: [],
  isolation: [],
  aiBus: [],
  constitutional: [],
  authentication: []
}

/**
 * Main test suite
 */
async function verifyMultiTenantIsolation() {
  console.log('\n' + '='.repeat(60))
  console.log('üß™ Multi-Tenant Isolation Verification')
  console.log('='.repeat(60))
  
  const payload = await getPayload({ config })
  
  // Test 1: Provision 3 test tenants
  console.log('\nüìã Test 1: Provisioning test tenants...')
  await testTenantProvisioning(payload)
  
  // Test 2: Verify data isolation
  console.log('\nüîí Test 2: Verifying data isolation...')
  await testDataIsolation(payload)
  
  // Test 3: AI Bus message visibility
  console.log('\nüì° Test 3: Testing AI Bus visibility...')
  await testAIBusVisibility(payload)
  
  // Test 4: Constitutional defaults
  console.log('\nüìú Test 4: Verifying constitutional defaults...')
  await testConstitutionalDefaults(payload)
  
  // Test 5: User authentication per tenant
  console.log('\nüîê Test 5: Testing user authentication...')
  await testUserAuthentication(payload)
  
  // Generate report
  generateReport()
  
  // Export detailed results
  await exportDetailedResults()
  
  console.log('')
}

/**
 * Test tenant provisioning
 */
async function testTenantProvisioning(payload) {
  const tenantSlugs = ['clearwater', 'example', 'test-ministry']
  
  for (const slug of tenantSlugs) {
    try {
      // Check if tenant exists
      const existing = await payload.find({
        collection: 'tenants',
        where: { slug: { equals: slug } },
        limit: 1
      })
      
      if (existing.docs.length > 0) {
        console.log(`   ‚úì Tenant "${slug}" already exists`)
        testResults.provisioning.push({
          tenant: slug,
          status: 'existing',
          id: existing.docs[0].id
        })
      } else {
        // Create tenant
        const tenant = await payload.create({
          collection: 'tenants',
          data: {
            name: slug.charAt(0).toUpperCase() + slug.slice(1),
            slug: slug,
            domain: `${slug}.localhost`,
            status: 'active'
          }
        })
        
        console.log(`   ‚úì Created tenant "${slug}" (ID: ${tenant.id})`)
        testResults.provisioning.push({
          tenant: slug,
          status: 'created',
          id: tenant.id
        })
      }
    } catch (error) {
      console.error(`   ‚úó Failed to provision "${slug}":`, error.message)
      testResults.provisioning.push({
        tenant: slug,
        status: 'failed',
        error: error.message
      })
    }
  }
}

/**
 * Test data isolation between tenants
 */
async function testDataIsolation(payload) {
  const clearwater = testResults.provisioning.find(t => t.tenant === 'clearwater')
  const example = testResults.provisioning.find(t => t.tenant === 'example')
  
  if (!clearwater || !example) {
    console.log('   ‚ö†Ô∏è  Skipping - tenants not provisioned')
    return
  }
  
  try {
    // Create a product in clearwater tenant
    const clearwaterProduct = await payload.create({
      collection: 'products',
      data: {
        title: 'Clearwater Test Product',
        slug: 'clearwater-test',
        tenant: clearwater.id,
        status: 'published'
      }
    })
    
    // Try to fetch from example tenant context
    const exampleProducts = await payload.find({
      collection: 'products',
      where: {
        tenant: { equals: example.id }
      }
    })
    
    const foundInWrongTenant = exampleProducts.docs.find(
      p => p.id === clearwaterProduct.id
    )
    
    if (foundInWrongTenant) {
      console.log('   ‚úó ISOLATION BREACH: Product visible across tenants')
      testResults.isolation.push({
        test: 'product_isolation',
        status: 'breach',
        details: 'Clearwater product visible in Example tenant'
      })
    } else {
      console.log('   ‚úì Products properly isolated')
      testResults.isolation.push({
        test: 'product_isolation',
        status: 'isolated'
      })
    }
    
  } catch (error) {
    console.error('   ‚úó Isolation test failed:', error.message)
    testResults.isolation.push({
      test: 'product_isolation',
      status: 'error',
      error: error.message
    })
  }
}

/**
 * Test AI Bus message visibility
 */
async function testAIBusVisibility(payload) {
  const clearwater = testResults.provisioning.find(t => t.tenant === 'clearwater')
  const example = testResults.provisioning.find(t => t.tenant === 'example')
  
  if (!clearwater || !example) {
    console.log('   ‚ö†Ô∏è  Skipping - tenants not provisioned')
    return
  }
  
  try {
    // Create tenant-visibility message in clearwater
    const clearwaterMessage = await payload.create({
      collection: 'messages',
      data: {
        content: {
          type: 'system',
          text: 'Clearwater tenant message'
        },
        messageType: 'system',
        visibility: 'tenant',
        tenant: clearwater.id,
        space: '1', // Dummy space ID
        sender: '1' // Dummy user ID
      }
    })
    
    // Try to fetch from example tenant
    const exampleMessages = await payload.find({
      collection: 'messages',
      where: {
        tenant: { equals: example.id },
        visibility: { equals: 'tenant' }
      }
    })
    
    const foundInWrongTenant = exampleMessages.docs.find(
      m => m.id === clearwaterMessage.id
    )
    
    if (foundInWrongTenant) {
      console.log('   ‚úó VISIBILITY BREACH: Tenant message visible across tenants')
      testResults.aiBus.push({
        test: 'tenant_visibility',
        status: 'breach',
        details: 'Tenant-level message leaked to another tenant'
      })
    } else {
      console.log('   ‚úì Tenant visibility properly isolated')
      testResults.aiBus.push({
        test: 'tenant_visibility',
        status: 'isolated'
      })
    }
    
    // Create network-visibility message
    const networkMessage = await payload.create({
      collection: 'messages',
      data: {
        content: {
          type: 'system',
          text: 'Network-wide message'
        },
        messageType: 'system',
        visibility: 'network',
        tenant: clearwater.id,
        space: '1',
        sender: '1'
      }
    })
    
    // Network messages should be visible to all tenants
    const allNetworkMessages = await payload.find({
      collection: 'messages',
      where: {
        visibility: { equals: 'network' }
      }
    })
    
    const networkMessageFound = allNetworkMessages.docs.find(
      m => m.id === networkMessage.id
    )
    
    if (networkMessageFound) {
      console.log('   ‚úì Network visibility works correctly')
      testResults.aiBus.push({
        test: 'network_visibility',
        status: 'isolated'
      })
    } else {
      console.log('   ‚úó Network visibility failed')
      testResults.aiBus.push({
        test: 'network_visibility',
        status: 'breach',
        details: 'Network message not visible'
      })
    }
    
  } catch (error) {
    console.error('   ‚úó AI Bus visibility test failed:', error.message)
    testResults.aiBus.push({
      test: 'ai_bus_visibility',
      status: 'error',
      error: error.message
    })
  }
}

/**
 * Test constitutional defaults
 */
async function testConstitutionalDefaults(payload) {
  const clearwater = testResults.provisioning.find(t => t.tenant === 'clearwater')
  
  if (!clearwater) {
    console.log('   ‚ö†Ô∏è  Skipping - tenant not provisioned')
    return
  }
  
  try {
    // Create message without specifying visibility
    const message = await payload.create({
      collection: 'messages',
      data: {
        content: {
          type: 'system',
          text: 'Constitutional default test'
        },
        messageType: 'system',
        // visibility NOT specified - should default to 'tenant'
        tenant: clearwater.id,
        space: '1',
        sender: '1'
      }
    })
    
    if (message.visibility === 'tenant') {
      console.log('   ‚úì Constitutional default (tenant) applied correctly')
      testResults.constitutional.push({
        test: 'default_visibility',
        status: 'pass',
        details: 'visibility defaulted to tenant per Article IV.2'
      })
    } else {
      console.log(`   ‚úó Constitutional default violated: visibility=${message.visibility}`)
      testResults.constitutional.push({
        test: 'default_visibility',
        status: 'fail',
        details: `Expected 'tenant', got '${message.visibility}'`
      })
    }
    
    // Test private visibility requires justification
    try {
      await payload.create({
        collection: 'messages',
        data: {
          content: { type: 'system', text: 'Private test' },
          messageType: 'system',
          visibility: 'private',
          // constitutionalNote NOT provided
          tenant: clearwater.id,
          space: '1',
          sender: '1'
        }
      })
      
      console.log('   ‚úó Private visibility allowed without justification')
      testResults.constitutional.push({
        test: 'private_justification',
        status: 'fail',
        details: 'Private visibility should require constitutionalNote'
      })
    } catch (error) {
      if (error.message.includes('justification')) {
        console.log('   ‚úì Private visibility requires justification (Article IV.3)')
        testResults.constitutional.push({
          test: 'private_justification',
          status: 'pass'
        })
      } else {
        throw error
      }
    }
    
  } catch (error) {
    console.error('   ‚úó Constitutional test failed:', error.message)
    testResults.constitutional.push({
      test: 'constitutional_defaults',
      status: 'error',
      error: error.message
    })
  }
}

/**
 * Test user authentication per tenant
 */
async function testUserAuthentication(payload) {
  const tenants = testResults.provisioning.filter(t => t.status !== 'failed')
  
  for (const tenant of tenants) {
    try {
      // Check if admin user exists for this tenant
      const users = await payload.find({
        collection: 'users',
        where: {
          tenant: { equals: tenant.id }
        },
        limit: 1
      })
      
      if (users.docs.length > 0) {
        console.log(`   ‚úì User authentication verified for ${tenant.tenant}`)
        testResults.authentication.push({
          tenant: tenant.tenant,
          status: 'pass'
        })
      } else {
        console.log(`   ‚ö†Ô∏è  No users found for ${tenant.tenant}`)
        testResults.authentication.push({
          tenant: tenant.tenant,
          status: 'warning',
          details: 'No users exist for this tenant'
        })
      }
    } catch (error) {
      console.error(`   ‚úó Authentication test failed for ${tenant.tenant}:`, error.message)
      testResults.authentication.push({
        tenant: tenant.tenant,
        status: 'error',
        error: error.message
      })
    }
  }
}

/**
 * Generate comprehensive test report
 */
function generateReport() {
  console.log('\n' + '='.repeat(60))
  console.log('üìä TEST RESULTS SUMMARY')
  console.log('='.repeat(60))
  
  // Provisioning summary
  const provisioningPass = testResults.provisioning.filter(r => r.status === 'created' || r.status === 'existing').length
  console.log(`\nüìã Provisioning: ${provisioningPass}/${testResults.provisioning.length} tenants ready`)
  
  // Isolation summary
  const isolationPass = testResults.isolation.filter(r => r.status === 'isolated').length
  const isolationBreach = testResults.isolation.filter(r => r.status === 'breach').length
  console.log(`\nüîí Data Isolation: ${isolationPass}/${testResults.isolation.length} tests passed`)
  if (isolationBreach > 0) {
    console.log(`   ‚ùå ${isolationBreach} ISOLATION BREACHES DETECTED`)
  }
  
  // AI Bus summary
  const aiBusPass = testResults.aiBus.filter(r => r.status === 'isolated').length
  const aiBusBreach = testResults.aiBus.filter(r => r.status === 'breach').length
  console.log(`\nüì° AI Bus Visibility: ${aiBusPass}/${testResults.aiBus.length} tests passed`)
  if (aiBusBreach > 0) {
    console.log(`   ‚ùå ${aiBusBreach} VISIBILITY BREACHES DETECTED`)
  }
  
  // Constitutional summary
  const constitutionalPass = testResults.constitutional.filter(r => r.status === 'pass').length
  console.log(`\nüìú Constitutional Compliance: ${constitutionalPass}/${testResults.constitutional.length} tests passed`)
  
  // Authentication summary
  const authPass = testResults.authentication.filter(r => r.status === 'pass').length
  console.log(`\nüîê Authentication: ${authPass}/${testResults.authentication.length} tenants verified`)
  
  // Overall status
  const totalTests = testResults.provisioning.length +
                     testResults.isolation.length +
                     testResults.aiBus.length +
                     testResults.constitutional.length +
                     testResults.authentication.length
  const totalPass = provisioningPass + isolationPass + aiBusPass + constitutionalPass + authPass
  const totalBreach = isolationBreach + aiBusBreach
  
  console.log('\n' + '='.repeat(60))
  console.log(`üéØ OVERALL: ${totalPass}/${totalTests} tests passed`)
  
  if (totalBreach > 0) {
    console.log(`\n‚ùå CRITICAL: ${totalBreach} SECURITY BREACHES DETECTED`)
    console.log('üö® DO NOT DEPLOY - Tenant isolation is compromised')
  } else if (totalPass === totalTests) {
    console.log('\n‚úÖ ALL TESTS PASSED')
    console.log('üéâ Multi-tenant isolation verified')
    console.log('üìú Constitutional compliance confirmed')
    console.log('üöÄ Ready for production deployment')
  } else {
    console.log('\n‚ö†Ô∏è  SOME TESTS FAILED')
    console.log('üîç Review failures before deployment')
  }
  
  console.log('\nüí° SUBDOMAIN TESTING:')
  console.log('   Add to hosts file for subdomain testing:')
  console.log('   127.0.0.1 clearwater.localhost example.localhost test-ministry.localhost')
  console.log('')
  console.log('üìù Full test results exported to: TEST_RESULTS_MULTI_TENANT.md')
  console.log('='.repeat(60))
}

/**
 * Export detailed results to markdown
 */
async function exportDetailedResults() {
  const { promises: fs } = await import('fs')
  const path = await import('path')
  
  let markdown = `# Multi-Tenant Isolation Test Results\n\n`
  markdown += `**Date:** ${new Date().toISOString()}\n\n`
  markdown += `---\n\n`
  
  // Provisioning
  markdown += `## üìã Tenant Provisioning\n\n`
  for (const result of testResults.provisioning) {
    const status = result.status === 'created' || result.status === 'existing' ? '‚úì' : '‚úó'
    markdown += `- ${status} **${result.tenant}** - ${result.status}\n`
    if (result.id) markdown += `  - ID: ${result.id}\n`
    if (result.error) markdown += `  - Error: ${result.error}\n`
  }
  
  // Data Isolation
  markdown += `\n## üîí Data Isolation\n\n`
  for (const result of testResults.isolation) {
    const status = result.status === 'isolated' ? '‚úì' : '‚úó'
    markdown += `- ${status} **${result.test}** - ${result.status}\n`
    if (result.details) markdown += `  - ${result.details}\n`
    if (result.error) markdown += `  - Error: ${result.error}\n`
  }
  
  // AI Bus Visibility
  markdown += `\n## üì° AI Bus Message Visibility\n\n`
  for (const result of testResults.aiBus) {
    const status = result.status === 'isolated' ? '‚úì' : '‚úó'
    markdown += `- ${status} **${result.test}** - ${result.status}\n`
    if (result.details) markdown += `  - ${result.details}\n`
    if (result.error) markdown += `  - Error: ${result.error}\n`
  }
  
  // Constitutional Compliance
  markdown += `\n## üìú Constitutional Compliance\n\n`
  for (const result of testResults.constitutional) {
    const status = result.status === 'pass' ? '‚úì' : '‚úó'
    markdown += `- ${status} **${result.test}** - ${result.status}\n`
    if (result.details) markdown += `  - ${result.details}\n`
    if (result.error) markdown += `  - Error: ${result.error}\n`
  }
  
  // Authentication
  markdown += `\n## üîê User Authentication\n\n`
  for (const result of testResults.authentication) {
    const status = result.status === 'pass' ? '‚úì' : result.status === 'warning' ? '‚ö†Ô∏è' : '‚úó'
    markdown += `- ${status} **${result.tenant}** - ${result.status}\n`
    if (result.details) markdown += `  - ${result.details}\n`
    if (result.error) markdown += `  - Error: ${result.error}\n`
  }
  
  // Write file
  const outputPath = path.default.join(process.cwd(), 'TEST_RESULTS_MULTI_TENANT.md')
  await fs.writeFile(outputPath, markdown, 'utf8')
}

// Run tests if executed directly
import { fileURLToPath } from 'url'
const __filename = fileURLToPath(import.meta.url)

if (process.argv[1] === __filename) {
  verifyMultiTenantIsolation()
    .then(() => {
      console.log('\n‚úÖ Test suite completed successfully')
      process.exit(0)
    })
    .catch((error) => {
      console.error('\n‚ùå Test suite failed:', error)
      process.exit(1)
    })
}

export { verifyMultiTenantIsolation, testResults }
